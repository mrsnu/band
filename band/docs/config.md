# Configuration and its Builder for Band Runtime

There are four configuration objects for each Band's component.

Each configuration field is optional or required. If a field is optional, then it is guaranteed that the default value exists. If a field is required, a configuration cannot be generated by `RuntimeConfigBuilder` without specifying the field.

### Enumeration Types
- `BandSchedulerType`:
  - `kBandFixedDevice`: 
  - `kBandRoundRobin`: 
  - `kBandShortestExpectedLatency`: 
  - `kBandFixedDeviceGlobalQueue`: 
  - `kBandHeterogeneousEarliestFinishTime`: 
  - `kBandLeastSlackTimeFirst`: 
  - `kBandHeterogeneousEarliestFinishTimeReserved`

- `BandCPUMaskFlags`: 
   - `kBandAll`
   - `kBandLittle`
   - `kBandBig`
   - `kBandPrimary`
  
- `BandDeviceFlags`: 
  - `kBandCPU`
  - `kBandGPU`
  - `kBandDSP`
  - `kBandNPU`

- `BandSubgraphPreparationType`: 
  - `kBandNoFallbackSubgraph`
  - `kBandFallbackPerDevice`
  - `kBandUnitSubgraph`
  - `kBandMergeUnitSubgraph`

## `ProfileConfig`
- `online` [type: `bool`, default: `true`]: Profile online if true, offline if false.
- `num_warmups` [type: `int`, default: `1`]: The number of warmup runs before profile.
- `num_runs` [type: `int`, default: `1`]: The number of runs for profile
- `copy_computation_ratio` [type: `std::vector<int>`, default: `[30000, ...]`]: The ratio of computation to input-output copy. Used for latency estimation. The size of the list should be the same as the number of devices.
- `smoothing_factor` [type: `float`, default: `0.1`]: The momentum to reflect current profiled data. `<updateed_profile> = <smoothing_factor> * <curr_profile> + (1. - <smoothing_factor>) * <prev_profile>`.
- `profile_data_path` [type: `std::string`, default: `""`]: The input path to the file for offline profile results. If not specified, this will be ignored and will not generate the result file. 

## `PlannerConfig`
- `schedule_window_size` [type: `int`, default: `INT_MAX`]: The size of window that scheduler will use.
- `schedulers` [type: `std::vector<BandSchedulerType>`, __required__]: The types of schedulers. If `N` schedulers are specified, `N` queues will be generated.
- `cpu_mask` [type: `BandCPUMaskFlags`, default: `kBandAll`]: CPU masks to set CPU affinity.
- `log_path` [type: `std::string`, default: `""`]: The output path to the file for planner's log. If not specified, this will be ignored and will not generate the result file. 

## `WorkerConfig`
- `workers` [type: `std::vector<BandDeviceFlags>`, default: `[kBandCPU, kBandGPU, ...]`]: The list of target devices. By default, one worker per device is generated.
- `cpu_masks` [type: `std::vector<BandCPUMaskFlags>`, default: `[kBandAll, kBandAll, ...]`]: CPU masks to set CPU affinity. The size of the list must be the same as the size of `workers`.
- `num_threads` [type: `std::vector<int>`, default: `[1, 1, ...]`]: The number of threads. The size of the list must be the same as the size of `workers`.
- `allow_worksteal` [type: `bool`, default: `false`]: Work-stealing is enabled if true, disabled if false.
- `availability_check_interval_ms` [type: `int`, default: `30_000`]: The interval for checking availability of devices. Used for detecting thermal throttling.

## `ModelConfig`
- `models` [type: `std::string`]: The list of models. By default, no models is defined.
- `models_period_ms_` [type: `int`]. Period in ms. If the period is specified for a specific model, all other models' period must also be specified.
- `models_batch_size_` [type: `int`]: Batch size.  If the batch size is specified for a specific model, all other models' batch size must also be specified.
- `models_slo_us_` [type: `int64_t`]: Slo in us. If the slo is specified for a specific model, all other models' slo must also be specified.
- `models_slo_scale_` [type: `float`]: Slo scale. If the slo scale is specified for a specific model, all other models' slo scale must also be specified.
- `models_assigned_worker_` [type: `BandDeviceFlags`]: If the worker is specified for a specific model, all other models' worker must also be specified.
- `models_worker_affinity_` [type: `int`]: If the worker is specified for a specific model, worker affinity must also be specified.

## `RuntimeConfig`
- `RuntimeConfig` contains `ProfileConfig`, `PlannerConfig` and `WorkerConfig`.
- `minimum_subgraph_size` [type: `int`, default: `7`]: The minimum subgraph size. If candidate subgraph size is smaller than this, the subgraph will not be created.
- `subgraph_preparation_type` [type: `BandSubgraphPreparationType`, default: `kBandMergeUnitSubgraph`]: For fallback schedulers, determine how to generate candidate subgraphs.
- `cpu_mask` [type: `BandCPUMaskFlags`, default: `kBandAll`]: The CPU mask for Band Engine.

## `RuntimeConfigBuilder` API
`RuntimeConfigBuilder` delegates all builder that inherits `ConfigBuilder`.
It is a `friend` class of all the other `ConfigBuilder` classes, so make sure to not change their members in `RuntimeConfigBuilder`.

### Exmaple Usage
```c++
RuntimeConfigBuilder b;
auto config = b.AddOnline(false)  // Default was `true`
                  .AddSmoothingFactor(0.3)  // Default was `0.1`
                  .AddSchedulers({kBandRoundRobin, kBandLeastSlackTimeFirst})  // Required field.
                  .Build();
```
### Methods
All `Add*` methods are idempotent, i.e. multiple calls behaves the same as a single call.
- `AddOnline(bool online)`
- `AddNumWarmups(int num_warmups)`
- `AddNumRuns(int num_runs)`
- `AddCopyComputationRatio(std::vector<int> copy_computation_ratio)`
- `AddSmoothingFactor(float smoothing_factor)`
- `AddProfileLogPath(std::string profile_data_path)`
- `AddPlannerLogPath(std::string planner_log_path)`
- `AddScheduleWindowSize(int schedule_window_size)`
- `AddSchedulers(std::vector<BandSchedulerType> schedulers)`
- `AddPlannerCPUMask(BandCPUMaskFlags cpu_masks)`
- `AddWorkers(std::vector<BandDeviceFlags> workers)`
- `AddWorkerCPUMasks(std::vector<BandCPUMaskFlags> cpu_masks)`
- `AddWorkerNumThreads(std::vector<int> num_threads)`
- `AddAllowWorkSteal(bool allow_worksteal)`
- `AddAvailabilityCheckIntervalMs(int32_t availability_check_interval_ms)`
- `AddMinimumSubgraphSize(int minimum_subgraph_size)`
- `AddSubgraphPreparationType(BandSubgraphPreparationType subgraph_preparation_type)`
- `AddCPUMask(BandCPUMaskFlags cpu_mask)`